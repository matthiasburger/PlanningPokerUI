<div class="container">
  @if (roomService.isReconnecting()) {
    <div class="reconnect-overlay">
      <div class="spinner"></div>
      <p>Reconnecting…</p>
    </div>
  }

  <h1>Planning Poker</h1>

  @if (roomService.snapshot())
  {
    <div class="room-container">
      <div class="room-header">
        <h2>
          Room: <span class="room-id">{{ roomService.snapshot()!.roomId }}</span> <br>
          User: <span class="display-name">{{ roomService.displayName() }} {{isFacilitator(roomService.userId())?'(Facilitator)':''}}</span>
        </h2>
        <button type="button" class="leave-btn" (click)="leaveRoom()">Leave</button>
      </div>

      <!--
      <div class="story-section">
        <label for="storyTitle">Story Titel:</label>
        <input id="storyTitle" #storyInput [value]="roomService.snapshot()!.storyTitle"
               (change)="roomService.setStory(storyInput.value)" />
      </div>
      -->

      <div class="participants-section">
        <h3>Participants</h3>
        <div class="poker-table">
          <div class="participants-around-table">
            @for (participant of roomService.snapshot()!.participants; track participant.userId) {
              <div class="participant-seat"
                   [class.current-user-seat]="isCurrentUser(participant)">

                <div class="participant-card"
                     [class.has-voted]="participant.vote && !isCurrentUser(participant)"
                     [class.not-voted]="!participant.vote"
                     [class.current-user-vote]="participant.vote && isCurrentUser(participant)"
                     [class.revealed]="roomService.snapshot()!.revealed">

                  <!-- Example facilitator check, here just using name "Matt" -->
                  @if (isFacilitator(roomService.userId())) {
                    <div class="user-actions">
                      <!--<button class="action-user-btn">a</button>-->
                      <!--<button class="chat-user-btn">c</button>-->
                      @if (!isCurrentUser(participant)) {
                        <button class="kick-user-btn" (click)="kickUser(participant.userId)">x</button>
                      }
                    </div>
                  }

                  @if (!roomService.snapshot()!.revealed) {
                    @if (participant.vote) {
                      @if (isCurrentUser(participant)) {
                        <span class="card-text">{{ roomService.chosenCard() }}</span>
                      } @else {
                        <span class="card-text">&nbsp;</span>
                      }
                    } @else {
                      <span class="card-text">&nbsp;</span>
                    }
                  } @else {
                    <span class="card-text">{{ participant.vote }}</span>
                  }
                </div>

                <div class="participant-name">{{ participant.displayName }}{{isFacilitator(participant.userId)?'*':''}}</div>
              </div>
            }
          </div>
        </div>
      </div>

      <div class="cards">
        @for (card of roomService.cards; track card) {
          <button type="button"
                  class="card"
                  [disabled]="roomService.snapshot()!.revealed"
                  [class.selected]="isCardSelected(card)"
                  (click)="chooseCard(card)">
            <div class="card-content">
              <span class="card-index top-left">{{ card }}</span>
              <span class="card-value">{{ card }}</span>
              <span class="card-index bottom-right">{{ card }}</span>
            </div>
          </button>
        }
      </div>

      <div class="action-buttons">
        <button type="button" [disabled]="!isFacilitator(roomService.userId())" (click)="reveal()">Reveal</button>
        <button type="button" [disabled]="!isFacilitator(roomService.userId())" (click)="reset()">New Round</button>
      </div>
    </div>
  } @else {
    <div class="reconnect-overlay">
      <div class="spinner"></div>
      <p>Loading room…</p>
    </div>
  }
</div>
